<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Laporan Shift A (Final)</title>
  <style>
    :root{
      --bg:#f6f7f9; --card:#ffffff; --ink:#1f2937; --muted:#64748b; --line:#e5e7eb; --accent:#25d366; --danger:#ef4444;
    }
    .dark{
      --bg:#0f1115; --card:#141821; --ink:#e5e7eb; --muted:#a0aec0; --line:#2d3748;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--ink);}
    .wrap{max-width:900px; margin:24px auto; padding:16px;}
    h2{margin:0 0 12px}
    .card{background:var(--card); border:1px solid var(--line); border-radius:12px; padding:16px; box-shadow:0 1px 2px rgba(0,0,0,.04)}
    label{font-weight:600; display:block; margin-top:10px}
    .hint{font-size:12px; color:var(--muted); margin-top:4px}
    input, textarea, select{
      width:100%; padding:10px 12px; margin-top:6px; border-radius:10px; border:1px solid var(--line); background:#fff; font:inherit;
    }
    textarea{min-height:84px; resize:vertical}
    .grid-2{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .grid-3{display:grid; grid-template-columns:repeat(3,1fr); gap:12px}
    @media (max-width:640px){ .grid-2, .grid-3{grid-template-columns:1fr} }
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:10px 14px; border-radius:8px; border:1px solid var(--line); background:var(--accent); color:#fff; font-weight:700; cursor:pointer;
    }
    .btn.secondary{background:#111827}
    .btn.danger{background:var(--danger)}
    .btn.ghost{background:transparent; color:var(--ink)}
    .stack{display:grid; gap:12px}
    pre{
      background:#fff; border:1px dashed var(--line); border-radius:12px; padding:14px; white-space:pre-wrap; min-height:140px;
    }
    .oee-preview{margin-top:10px; padding:10px; background:#fff; border:1px dashed var(--line); border-radius:10px; font-size:14px}
    .bar{height:10px; border-radius:999px; overflow:hidden; background:#e5e7eb; margin-top:4px;}
    .bar span{display:block; height:100%; background:linear-gradient(90deg,#16a34a,#22c55e); width:0%;}
    .muted{font-size:12px; color:var(--muted)}
  </style>
</head>
<body>
<div class="wrap">
  <h2>Laporan Shift A – Final</h2>
  <div class="stack">
    <div class="grid-3">
      <div>
        <label>Tanggal</label>
        <input type="date" id="tanggal">
      </div>
      <div>
        <label>Nama Produk</label>
        <input type="text" id="produk" value="PTWCJ-HLD-003">
      </div>
      <div>
        <label>Shift</label>
        <select id="shift">
          <option value="A">A</option>
          <option value="B">B</option>
          <option value="C">C</option>
        </select>
      </div>
    </div>

    <div class="card">
      <h3>LINE 2</h3>
      <div class="grid-3">
        <div><label>Pulp Tank 205</label><input type="number" id="pulp205_2"></div>
        <div><label>Vitacel Mix A</label><input type="number" id="vit2a"></div>
        <div><label>Vitacel Mix B</label><input type="number" id="vit2b"></div>
        <div><label>Vitacel Standby</label><input type="number" id="vit2s"></div>
        <div><label>Adhesive Standby</label><input type="number" id="adh2s"></div>
        <div><label>Adhesive di Tangki</label><input type="number" id="adh2t"></div>
        <div><label>CMC</label><input type="number" id="cmc2"></div>
        <div><label>Recycle (set)</label><input type="number" id="rec2"></div>
        <div><label>Recycle per set (kg)</label><input type="number" id="rec2w"></div>
        <div><label>Mother Roll</label><input type="number" id="mr2"></div>
        <div><label>Total Berat FG (kg)</label><input type="number" id="fg2"></div>
      </div>
      <div class="grid-2">
        <div><label>Jumlah MR (Slitting)</label><input type="number" id="slit_mr2"><div class="hint">1 MR = 6 bobin</div></div>
        <div><label>Bobin Reject Produksi (pcs)</label><input type="number" id="reject_produksi2"></div>
        <div><label>Bobin Reject NCP (pcs)</label><input type="number" id="reject_ncp2"></div>
        <div><label>Total Bobin Manual (pcs)</label><input type="number" id="total_bobin_manual2"><div class="hint">1 bobin = 15 kg</div></div>
      </div>
      <div class="oee-preview">
        📈 OEE Line 2: <b><span id="oee2">-</span></b> <span class="muted" id="delta2"></span>
        <div class="bar"><span id="bar2"></span></div>
      </div>
    </div>

    <div class="card">
      <h3>LINE 3</h3>
      <div class="grid-3">
        <div><label>Pulp Tank 204</label><input type="number" id="pulp204_3"></div>
        <div><label>Vitacel Mix A</label><input type="number" id="vit3a"></div>
        <div><label>Vitacel Mix B</label><input type="number" id="vit3b"></div>
        <div><label>Vitacel Standby</label><input type="number" id="vit3s"></div>
        <div><label>Adhesive Standby</label><input type="number" id="adh3s"></div>
        <div><label>Adhesive di Tangki</label><input type="number" id="adh3t"></div>
        <div><label>CMC</label><input type="number" id="cmc3"></div>
        <div><label>Recycle (set)</label><input type="number" id="rec3"></div>
        <div><label>Recycle per set (kg)</label><input type="number" id="rec3w"></div>
        <div><label>Mother Roll</label><input type="number" id="mr3"></div>
        <div><label>Total Berat FG (kg)</label><input type="number" id="fg3"></div>
      </div>
      <div class="grid-2">
        <div><label>Jumlah MR (Slitting)</label><input type="number" id="slit_mr3"><div class="hint">1 MR = 6 bobin</div></div>
        <div><label>Bobin Reject Produksi (pcs)</label><input type="number" id="reject_produksi3"></div>
        <div><label>Bobin Reject NCP (pcs)</label><input type="number" id="reject_ncp3"></div>
        <div><label>Total Bobin Manual (pcs)</label><input type="number" id="total_bobin_manual3"><div class="hint">1 bobin = 15 kg</div></div>
      </div>
      <div class="oee-preview">
        📈 OEE Line 3: <b><span id="oee3">-</span></b> <span class="muted" id="delta3"></span>
        <div class="bar"><span id="bar3"></span></div>
      </div>
    </div>

    <div class="card">
      <div class="grid-2">
        <div><label>Pulp Standby Tank 203</label><input type="number" id="pulp203"></div>
        <div><label>Catatan untuk Shift Selanjutnya</label><textarea id="catatan"></textarea></div>
      </div>
    </div>

    <div class="grid-2">
      <button class="btn" onclick="previewLaporan()">Tampilkan & Simpan Laporan</button>
      <button class="btn secondary" onclick="copyText()">Salin Teks</button>
      <button class="btn ghost" onclick="shareWA()">Kirim WA</button>
      <button class="btn danger" onclick="clearData()">Bersihkan Form</button>
      <button class="btn ghost" onclick="toggleTheme()">🌙 Mode</button>
    </div>

    <pre id="output"></pre>
  </div>

  <div class="card" style="margin-top: 24px;">
    <h3>📋 Laporan Tersimpan (Real-time)</h3>
    <div class="grid-3">
      <div>
        <label>Filter Tanggal</label>
        <input type="date" id="filterTanggal" onchange="renderLaporan()">
      </div>
      <div>
        <label>Filter Shift</label>
        <select id="filterShift" onchange="renderLaporan()">
          <option value="">Semua Shift</option>
          <option value="A">A</option>
          <option value="B">B</option>
          <option value="C">C</option>
        </select>
      </div>
    </div>
    <div id="laporanList" style="margin-top: 16px; display: grid; gap: 12px;">
      <p class="muted">Memuat laporan dari server...</p>
    </div>
  </div>
</div>

<script type="module">
  // Impor fungsi yang diperlukan dari Firebase SDK
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
  import { getDatabase, ref, push, set, onValue } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

  // =================================================================================
  // KONFIGURASI DARI FILE HTML PERTAMA ANDA
  // =================================================================================
  const firebaseConfig = {
    apiKey: "AIzaSyCReZ1Hs1p63Sq6DWODvwbKCgpVPUzVKQA",
    authDomain: "laporanharian-d689c.firebaseapp.com",
    databaseURL: "https://laporanharian-d689c-default-rtdb.firebaseio.com",
    projectId: "laporanharian-d689c",
    storageBucket: "laporanharian-d689c.appspot.com",
    messagingSenderId: "161606001787",
    appId: "1:161606001787:web:a2550a1abf208ce188aede",
    measurementId: "G-E9SL4RT4TB"
  };
  // =================================================================================

  // Inisialisasi Firebase
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  let semuaLaporan = {};

  // --- Konstanta dan Fungsi Helper ---
  const BOBIN_PER_MR = 6, KG_PER_BOBIN = 15, SPEED = 15, WIDTH = 1.2, GSM = 0.095, TIME = 480;
  const THEORETICAL_KG = SPEED*WIDTH*GSM*TIME;
  const nf = new Intl.NumberFormat('id-ID',{maximumFractionDigits:2});
  function g(id){let e=document.getElementById(id); return e&&e.value!==''?e.value:''}
  function n(id){return parseFloat(g(id))||0}
  function isFilled(data, keys){return keys.some(key=>data[key])}

  // --- Fungsi OEE ---
  function calcOEE(line, data){
    let totalMR= (parseFloat(data[`slit_mr${line}`]) || 0) * BOBIN_PER_MR;
    let reject = parseFloat(data[`reject_produksi${line}`]) || 0;
    let oke=Math.max(totalMR-reject,0)*KG_PER_BOBIN;
    return oke<=0? 0 :(oke/THEORETICAL_KG)*100
  }
  function updateOEEPreview(line, data){
    let oee = calcOEE(line, data);
    document.getElementById(`oee${line}`).textContent=nf.format(oee)+'%';
    document.getElementById(`bar${line}`).style.width=Math.min(oee,100)+'%';
  }

  // --- Fungsi Narasi Laporan ---
  function narasi(no, data){
    let t=`\n\n---\n\nLINE ${no}\n\nPersiapan Produksi:\n`;
    if(data[`pulp205_${no}`] || data[`pulp204_${no}`]) t+=`- Pulp Tank: ${data[`pulp205_${no}`] || data[`pulp204_${no}`]} set\n`;
    if(data[`vit${no}a`]) t+=`- Vitacel A: ${data[`vit${no}a`]} set\n`;
    if(data[`vit${no}b`]) t+=`- Vitacel B: ${data[`vit${no}b`]} set\n`;
    if(data[`vit${no}s`]) t+=`- Vitacel Standby: ${data[`vit${no}s`]} set\n`;
    if(data[`adh${no}s`]) t+=`- Adhesive Standby: ${data[`adh${no}s`]} set\n`;
    if(data[`adh${no}t`]) t+=`- Adhesive Tangki: ${data[`adh${no}t`]} set\n`;
    if(data[`cmc${no}`]) t+=`- CMC: ${data[`cmc${no}`]} set\n`;
    if(data[`rec${no}`] && data[`rec${no}w`]) t+=`- Recycle: ${data[`rec${no}`]} set (${data[`rec${no}w`]} kg/set)\n`;
    t+=`\nFinish Good:\n`; if(data[`mr${no}`]) t+=`- Mother Roll: ${data[`mr${no}`]} MR\n`; if(data[`fg${no}`]) t+=`- Berat FG: ${data[`fg${no}`]} kg\n`;
    
    const slit_mr = n(`slit_mr${no}`), rp = n(`reject_produksi${no}`), rn = n(`reject_ncp${no}`), totalManual = n(`total_bobin_manual${no}`);
    let totalBobin=slit_mr*BOBIN_PER_MR, oke=Math.max(totalBobin-rp,0), okeKg=oke*KG_PER_BOBIN;
    
    t+=`\nSlitting:\n- Slitting: ${totalBobin} bobin\n- Reject Produksi: ${rp} bobin\n- OKE: ${oke} bobin (${okeKg} kg)\n- Reject NCP: ${rn} bobin\n- Total Manual: ${totalManual} bobin (${totalManual*KG_PER_BOBIN} kg)\n`;
    t+=`\n📈 OEE: ${nf.format(calcOEE(no, data))}%\n`; return t;
  }

  // --- Fungsi Utama ---
  window.previewLaporan = function(){
    let dataLaporan = {};
    document.querySelectorAll('input,textarea,select').forEach(el => dataLaporan[el.id] = el.value);

    let isi=`LAPORAN SHIFT ${dataLaporan.shift}\nTanggal: ${dataLaporan.tanggal}\nProduk: ${dataLaporan.produk}`;
    if(isFilled(dataLaporan, ['pulp205_2', 'vit2a', 'mr2'])) isi += narasi(2, dataLaporan);
    if(isFilled(dataLaporan, ['pulp204_3', 'vit3a', 'mr3'])) isi += narasi(3, dataLaporan);
    if(dataLaporan.pulp203 || dataLaporan.catatan){
      isi+=`\n\nCatatan Tambahan:\n`; 
      if(dataLaporan.pulp203) isi+=`- Pulp 203: ${dataLaporan.pulp203} set\n`; 
      if(dataLaporan.catatan) isi+=`- ${dataLaporan.catatan}\n`;
    }
    document.getElementById('output').innerText=isi;
    updateOEEPreview(2, dataLaporan);
    updateOEEPreview(3, dataLaporan);
    saveDataLocal(); // Simpan ke localstorage untuk draft
    saveDataToFirebase(dataLaporan, isi); // Simpan ke server
  }

  function saveDataToFirebase(data, teksLaporan) {
    const tanggal = data.tanggal;
    if (!tanggal) {
      alert("⚠️ Tanggal wajib diisi untuk menyimpan laporan ke server!");
      return;
    }
    const laporanRef = ref(db, "laporan/" + tanggal);
    const newLaporanRef = push(laporanRef);
    set(newLaporanRef, {
      formData: data,
      teks: teksLaporan,
      waktu: new Date().toISOString()
    })
    .then(() => alert("✅ Laporan berhasil disimpan ke server!"))
    .catch((error) => {
      console.error("Gagal menyimpan:", error);
      alert("❌ Gagal menyimpan laporan ke server.");
    });
  }

  // --- Fungsi untuk Menampilkan Data Real-time ---
  const laporanListEl = document.getElementById('laporanList');
  window.renderLaporan = function() {
      const filterTanggal = g('filterTanggal');
      const filterShift = g('filterShift');
      laporanListEl.innerHTML = '';

      const dataUrut = Object.entries(semuaLaporan).sort((a,b) => b[0].localeCompare(a[0]));
      
      let adaLaporan = false;
      for (const [tanggal, laporanPerTanggal] of dataUrut) {
          if (filterTanggal && tanggal !== filterTanggal) continue;

          for (const item of Object.values(laporanPerTanggal).reverse()) {
              if (filterShift && item.formData.shift !== filterShift) continue;
              
              adaLaporan = true;
              const card = document.createElement('div');
              card.className = 'card';
              card.innerHTML = `
                  <p class="muted"><strong>${tanggal} - Shift ${item.formData.shift}</strong> | ${new Date(item.waktu).toLocaleTimeString('id-ID')}</p>
                  <pre style="white-space: pre-wrap; font-size: 13px;">${item.teks}</pre>
              `;
              laporanListEl.appendChild(card);
          }
      }
      if (!adaLaporan) {
          laporanListEl.innerHTML = '<p class="muted">Tidak ada laporan yang sesuai dengan filter.</p>';
      }
  }

  // Listener utama untuk data real-time dari Firebase
  onValue(ref(db, 'laporan'), (snapshot) => {
      semuaLaporan = snapshot.val() || {};
      renderLaporan();
  });

  // --- Fungsi Utilitas Lainnya ---
  window.copyText = function(){let t=document.getElementById('output').innerText; if(!t.trim()){alert('Laporan kosong!'); return;} navigator.clipboard.writeText(t).then(()=>alert('📋 Laporan disalin ke clipboard'))}
  window.shareWA = function(){let t=document.getElementById('output').innerText||''; if(!t.trim()){window.previewLaporan(); t=document.getElementById('output').innerText;} window.open(`https://wa.me/?text=${encodeURIComponent(t)}`,'_blank')}
  window.clearData = function(){if(!confirm('Hapus semua data di form? (Data di server tidak akan terhapus)'))return; document.querySelectorAll('input,textarea,select').forEach(el=>el.value=''); localStorage.removeItem('formData'); document.getElementById('output').innerText=''}
  window.toggleTheme = function(){document.body.classList.toggle('dark'); localStorage.setItem('theme',document.body.classList.contains('dark')?'dark':'light')}

  function saveDataLocal(){let d={}; document.querySelectorAll('input,textarea,select').forEach(el=>d[el.id]=el.value); localStorage.setItem('formData',JSON.stringify(d))}
  function restore(){
    let d=JSON.parse(localStorage.getItem('formData')||'{}'); 
    Object.keys(d).forEach(k=>{let el=document.getElementById(k); if(el)el.value=d[k]}); 
    if(localStorage.getItem('theme')==='dark')document.body.classList.add('dark');
    document.getElementById('tanggal').valueAsDate = new Date();
  }
  restore();

</script>
</body>
</html>
