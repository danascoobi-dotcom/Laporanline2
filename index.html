<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Laporan Harian Produksi ‚Äî OEE (Teori)</title>
<style>
  :root{--bg:#f6f7f9;--card:#fff;--muted:#6b7280;--accent:#0ea5a4;--danger:#ef4444;}
  body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial; background:var(--bg); margin:0; color:#0f172a;}
  .wrap{max-width:980px;margin:28px auto;padding:20px;}
  h1{margin:0 0 10px;font-size:20px}
  .grid{display:grid;gap:12px;grid-template-columns:repeat(3,1fr); margin-bottom:12px;}
  @media (max-width:880px){ .grid{grid-template-columns:repeat(2,1fr)} }
  @media (max-width:560px){ .grid{grid-template-columns:1fr} }
  .card{background:var(--card);border-radius:12px;padding:14px;border:1px solid #e6e9ee;box-shadow:0 1px 3px rgba(2,6,23,.04)}
  label{display:block;font-weight:600;margin-bottom:6px}
  input[type="number"], input[type="text"], select{width:100%;padding:8px;border-radius:8px;border:1px solid #e6e9ee;font:inherit}
  .small{font-size:13px;color:var(--muted)}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
  .btn.primary{background:var(--accent);color:#fff}
  .btn.ghost{background:transparent;border:1px solid #cbd5e1}
  .btn.danger{background:var(--danger);color:#fff}
  pre#report{white-space:pre-wrap;background:#fbfdff;border:1px dashed #e6e9ee;padding:12px;border-radius:10px;min-height:140px}
  .stat-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:10px}
  .stat{background:#f8fafc;padding:10px;border-radius:8px;text-align:center}
  .stat b{display:block;font-size:18px}
  .muted{color:var(--muted);font-size:13px}
  .hint{font-size:12px;color:#94a3b8}
</style>
</head>
<body>
<div class="wrap">
  <h1>Laporan Harian Produksi ‚Äî OEE (Availability √ó Performance √ó Quality)</h1>

  <div class="card">
    <div class="grid">
      <div>
        <label>Planned production time (menit)</label>
        <input type="number" id="plannedTime" value="480" min="1">
        <div class="hint">Waktu rencana produksi (mis. 480 = 8 jam)</div>
      </div>
      <div>
        <label>Downtime (menit)</label>
        <input type="number" id="downtime" value="0" min="0">
        <div class="hint">Total downtime (breakdown, setup). Isi 0 jika tidak ada.</div>
      </div>
      <div>
        <label>Kecepatan mesin (m/min)</label>
        <input type="number" id="speed" value="15" step="0.01" min="0">
        <div class="hint">Speed linier mesin.</div>
      </div>

      <div>
        <label>Lebar web (m)</label>
        <input type="number" id="width" value="1.2" step="0.01" min="0">
        <div class="hint">Lebar kertas / web.</div>
      </div>
      <div>
        <label>GSM (g/m¬≤)</label>
        <input type="number" id="gsm" value="95" step="0.1" min="0">
        <div class="hint">Gram per meter persegi (masukkan dalam g/m¬≤).</div>
      </div>
      <div>
        <label>Kg per bobin</label>
        <input type="number" id="kgPerBobin" value="15" step="0.1" min="0">
        <div class="hint">Konversi bobin ‚Üí kg (default 15 kg/bobin).</div>
      </div>
    </div>
  </div>

  <div style="height:12px;"></div>

  <div class="card">
    <h3 style="margin:0 0 8px">Data Produksi (Slitting)</h3>
    <div class="grid">
      <div>
        <label>Total Bobin (pcs)</label>
        <input type="number" id="totalBobin" value="36" min="0">
      </div>
      <div>
        <label>Reject Produksi (pcs)</label>
        <input type="number" id="rejectProd" value="3" min="0">
      </div>
      <div>
        <label>Reject NCP (pcs)</label>
        <input type="number" id="rejectNcp" value="20" min="0">
      </div>

      <div>
        <label>Grinding Input (kg)</label>
        <input type="number" id="grindingInput" value="1000" min="0">
        <div class="hint">Gunakan input grinding (kg) sebagai basis untuk OEE.</div>
      </div>

      <div>
        <label>Finish Good (kg)</label>
        <input type="number" id="finishGood" value="0" min="0">
      </div>
      <div>
        <label>Catatan (opsional)</label>
        <input type="text" id="note" placeholder="Catatan untuk shift berikutnya...">
      </div>
    </div>

    <div class="stat-grid" style="margin-top:12px">
      <div class="stat">
        <div class="muted">Availability</div>
        <b id="valAvailability">-</b>
        <div class="small muted" id="availDetail">‚Äî</div>
      </div>
      <div class="stat">
        <div class="muted">Performance</div>
        <b id="valPerformance">-</b>
        <div class="small muted" id="perfDetail">‚Äî</div>
      </div>
      <div class="stat">
        <div class="muted">Quality</div>
        <b id="valQuality">-</b>
        <div class="small muted" id="qualDetail">‚Äî</div>
      </div>
      <div class="stat">
        <div class="muted">OEE</div>
        <b id="valOEE">-</b>
        <div class="small muted" id="oeeDetail">‚Äî</div>
      </div>
    </div>

    <div style="margin-top:12px" class="row">
      <button class="btn primary" onclick="previewReport()">üëÅÔ∏è Preview</button>
      <button class="btn ghost" onclick="saveReport()">üíæ Simpan Laporan</button>
      <button id="btnDelete" class="btn danger" style="display:none" onclick="deleteReport()">üóëÔ∏è Hapus Laporan</button>
    </div>
  </div>

  <div style="height:12px;"></div>

  <div class="card">
    <h3 style="margin:0 0 8px">Hasil / Preview Laporan</h3>
    <pre id="report">Tekan "Preview" untuk melihat laporan.</pre>
  </div>
</div>

<script>
  // Helper
  const fmt = (n, d=2) => Number.isFinite(n) ? n.toFixed(d) : '-';
  const pct = (x) => (Number.isFinite(x) ? (x*100).toFixed(2) + ' %' : '-');

  // DOM refs
  const els = {
    plannedTime: document.getElementById('plannedTime'),
    downtime: document.getElementById('downtime'),
    speed: document.getElementById('speed'),
    width: document.getElementById('width'),
    gsm: document.getElementById('gsm'),
    kgPerBobin: document.getElementById('kgPerBobin'),
    totalBobin: document.getElementById('totalBobin'),
    rejectProd: document.getElementById('rejectProd'),
    rejectNcp: document.getElementById('rejectNcp'),
    grindingInput: document.getElementById('grindingInput'),
    finishGood: document.getElementById('finishGood'),
    note: document.getElementById('note'),
    report: document.getElementById('report'),
    valAvailability: document.getElementById('valAvailability'),
    valPerformance: document.getElementById('valPerformance'),
    valQuality: document.getElementById('valQuality'),
    valOEE: document.getElementById('valOEE'),
    availDetail: document.getElementById('availDetail'),
    perfDetail: document.getElementById('perfDetail'),
    qualDetail: document.getElementById('qualDetail'),
    oeeDetail: document.getElementById('oeeDetail'),
    btnDelete: document.getElementById('btnDelete')
  };

  // Core calculation
  function computeAll() {
    const planned = parseFloat(els.plannedTime.value) || 0;
    const downtime = parseFloat(els.downtime.value) || 0;
    const speed = parseFloat(els.speed.value) || 0;
    const width = parseFloat(els.width.value) || 0;
    const gsm_gm2 = parseFloat(els.gsm.value) || 0;
    const gsm = gsm_gm2 / 1000; // convert to kg/m2
    const kgPerBobin = parseFloat(els.kgPerBobin.value) || 0;
    const totalBobin = parseFloat(els.totalBobin.value) || 0;
    const rejectProd = parseFloat(els.rejectProd.value) || 0;
    const rejectNcp = parseFloat(els.rejectNcp.value) || 0;
    const grindingInput = parseFloat(els.grindingInput.value) || 0;

    // Availability
    const availability = (planned > 0) ? Math.max((planned - downtime) / planned, 0) : 0;

    // Theoretical kg (ideal) = speed(m/min) * width(m) * gsm(kg/m2) * planned_time(min)
    const theoreticalKg = speed * width * gsm * planned;

    // Actual kg for performance uses Total Bobin * kgPerBobin (per agreement)
    const actualKg = totalBobin * kgPerBobin;

    const performance = (theoreticalKg > 0) ? Math.max(actualKg / theoreticalKg, 0) : 0;

    // Quality = OK units / total units (bobin)
    const okeBobin = Math.max(totalBobin - rejectProd - rejectNcp, 0);
    const quality = (totalBobin > 0) ? Math.max(okeBobin / totalBobin, 0) : 0;

    // OEE
    const oee = availability * performance * quality;

    return {
      planned, downtime, speed, width, gsm_gm2, gsm, theoreticalKg, actualKg,
      totalBobin, rejectProd, rejectNcp, okeBobin, grindingInput,
      availability, performance, quality, oee
    };
  }

  // Update UI stats
  function updateStats() {
    const c = computeAll();
    els.valAvailability.textContent = pct(c.availability);
    els.availDetail.textContent = `${c.planned} min planned ‚Ä¢ ${c.downtime} min downtime`;

    els.valPerformance.textContent = pct(c.performance);
    els.perfDetail.textContent = `${fmt(c.actualKg,2)} kg actual / ${fmt(c.theoreticalKg,2)} kg ideal`;

    els.valQuality.textContent = pct(c.quality);
    els.qualDetail.textContent = `${c.okeBobin} OK / ${c.totalBobin} total bobin`;

    els.valOEE.textContent = pct(c.oee);
    els.oeeDetail.textContent = `(A√óP√óQ) ‚Äî ${pct(c.availability)} √ó ${pct(c.performance)} √ó ${pct(c.quality)}`;
  }

  // Compose report text
  function buildReportText() {
    const c = computeAll();
    const dt = new Date().toLocaleString('id-ID');
    const okeKg = c.okeBobin * (parseFloat(els.kgPerBobin.value) || 0);

    const lines = [];
    lines.push(`üìå LAPORAN HARIAN PRODUKSI`);
    lines.push(`Tanggal: ${dt}`);
    lines.push(`=============================\n`);

    lines.push(`üîπ Grinding`);
    lines.push(`   Planned time : ${c.planned} menit`);
    lines.push(`   Downtime     : ${c.downtime} menit`);
    lines.push(`   Grinding Input (kg): ${c.grindingInput}\n`);

    lines.push(`üîπ Mesin (parameter)`);
    lines.push(`   Speed         : ${c.speed} m/min`);
    lines.push(`   Width         : ${c.width} m`);
    lines.push(`   GSM           : ${c.gsm_gm2} g/m¬≤`);
    lines.push(`   Theoretical output (kg): ${fmt(c.theoreticalKg,2)}\n`);

    lines.push(`üîπ Finish Good`);
    lines.push(`   Finish Good (kg): ${els.finishGood.value || 0}\n`);

    lines.push(`üîπ Slitting`);
    lines.push(`   Total Bobin       : ${c.totalBobin} bobin`);
    lines.push(`   Reject Produksi   : ${c.rejectProd} bobin`);
    lines.push(`   Reject NCP        : ${c.rejectNcp} bobin`);
    lines.push(`   ‚úÖ OKE             : ${c.okeBobin} bobin (${fmt(okeKg,2)} kg)\n`);

    lines.push(`üìä OEE (A √ó P √ó Q)`);
    lines.push(`   Availability : ${pct(c.availability)} (${c.planned - c.downtime}/${c.planned} menit)`);
    lines.push(`   Performance  : ${pct(c.performance)} (${fmt(c.actualKg,2)} kg actual dari ${fmt(c.theoreticalKg,2)} kg ideal)`);
    lines.push(`   Quality      : ${pct(c.quality)} (${c.okeBobin} / ${c.totalBobin} bobin)`);
    lines.push(`\n   => OEE = ${pct(c.oee)}\n`);

    if (els.note.value) {
      lines.push(`Catatan: ${els.note.value}\n`);
    }

    lines.push(`=============================\n`);
    return lines.join('\n');
  }

  // Preview button
  function previewReport() {
    updateStats();
    els.report.textContent = buildReportText();
  }

  // Save to localStorage
  const STORAGE_KEY = 'laporan_oee_v1';
  function saveReport(){
    previewReport();
    const data = {
      timestamp: new Date().toISOString(),
      form: {
        plannedTime: els.plannedTime.value,
        downtime: els.downtime.value,
        speed: els.speed.value,
        width: els.width.value,
        gsm: els.gsm.value,
        kgPerBobin: els.kgPerBobin.value,
        totalBobin: els.totalBobin.value,
        rejectProd: els.rejectProd.value,
        rejectNcp: els.rejectNcp.value,
        grindingInput: els.grindingInput.value,
        finishGood: els.finishGood.value,
        note: els.note.value
      },
      reportText: els.report.textContent
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    alert('‚úÖ Laporan tersimpan di localStorage.');
    els.btnDelete.style.display = 'inline-block';
  }

  // Delete with simple prompt auth
  function deleteReport(){
    const user = prompt('Masukkan username:');
    if(user !== 'Tirta'){ alert('Username salah'); return; }
    const pass = prompt('Masukkan password:');
    if(pass !== 'Komunitas'){ alert('Password salah'); return; }
    localStorage.removeItem(STORAGE_KEY);
    els.report.textContent = 'Laporan dihapus.';
    els.btnDelete.style.display = 'none';
    alert('Semua laporan berhasil dihapus.');
  }

  // Load existing saved report on load
  function loadSaved(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return;
    try{
      const data = JSON.parse(raw);
      const f = data.form || {};
      els.plannedTime.value = f.plannedTime ?? els.plannedTime.value;
      els.downtime.value = f.downtime ?? els.downtime.value;
      els.speed.value = f.speed ?? els.speed.value;
      els.width.value = f.width ?? els.width.value;
      els.gsm.value = f.gsm ?? els.gsm.value;
      els.kgPerBobin.value = f.kgPerBobin ?? els.kgPerBobin.value;
      els.totalBobin.value = f.totalBobin ?? els.totalBobin.value;
      els.rejectProd.value = f.rejectProd ?? els.rejectProd.value;
      els.rejectNcp.value = f.rejectNcp ?? els.rejectNcp.value;
      els.grindingInput.value = f.grindingInput ?? els.grindingInput.value;
      els.finishGood.value = f.finishGood ?? els.finishGood.value;
      els.note.value = f.note ?? els.note.value;
      els.report.textContent = data.reportText || 'Preview laporan...';
      els.btnDelete.style.display = 'inline-block';
      updateStats();
    }catch(e){ console.warn('gagal load saved', e) }
  }

  // Realtime update
  document.querySelectorAll('input').forEach(inp=>{
    inp.addEventListener('input', ()=>{
      updateStats();
    });
  });

  // Init
  loadSaved();
  updateStats();

  // Expose functions to global for buttons
  window.previewReport = previewReport;
  window.saveReport = saveReport;
  window.deleteReport = deleteReport;
</script>
</body>
</html>
